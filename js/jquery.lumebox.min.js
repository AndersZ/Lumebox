/* Lumebox $ plugin
 * Copyright Anders Zakrisson/Sogeti 2009-2011
 * http://anders.zakrisson.se, http://www.sogeti.se
 * This software is released under the GPL License.
 */
(function(e){function t(e){this.title=null;this.link=null;this.content=null;this.snippet=null;this.published=null;this.id=null;this.media=null}function n(){this.title=null;this.link=null;this.description=null;this.version=null;this.items=new Array}e.lumebox={loader:function(t){if(t.feedApiKey!=(null||undefined)){e.getScript("http://www.google.com/jsapi?key"+t.feedApiKey,function(){google.load("feeds","1",{nocss:true,callback:function(){e.lumebox.init(t)}})})}else{e.lumebox.init(t)}},settings:{showAsList:false,rss:new Array,proxy:"",duration:"medium",rssWidth:680,opacity:"0.7",loop:true,scrollToTop:false,autoNext:false,parentElementId:false,useParentOffset:true,useGestures:true,graphicsDir:"style/",feedApiKey:false,platformMode:"auto",noCaptionClass:"tn"},data:{lumeboxItems:new n,lumeboxFeeds:new Object,popupStatus:0,group:null,timeoutId:null,parentElement:null,index:1},init:function(r){r?e.lumebox.settings=e.extend({},e.lumebox.settings,r):r={};if(this.settings.parentElementId){e.lumebox.data.parentElement=e("#"+this.settings.parentElementId)}else{e.lumebox.data.parentElement=e("body").eq(0)}e.lumebox.data.parentElement.append('<div id="lumebox-popup"><div id="lumebox-topmenu"><a href="#" id="lumebox-close" class="lumebox-controls"><img src="'+e.lumebox.settings.graphicsDir+'icon_close.png"></a><p id="lumebox-counter"></p></div><div id="lumebox-content"></div></div><div id="lumebox-bg"></div>');if(e.lumebox.settings.platformMode=="auto"&&(navigator.platform.indexOf("iPhone")!=-1||navigator.platform.indexOf("iPod")!=-1||navigator.userAgent.indexOf("iPad")!=-1||navigator.userAgent.indexOf("Android")!=-1)){e.lumebox.settings.platformMode="mobile";e.lumebox.settings.opacity=1;e("#lumebox-popup").addClass("mobile")}e("#lumebox-close").click(function(){e.lumebox.close()});if(e.lumebox.settings.platformMode!="mobile"){e("#lumebox-bg").click(function(){e.lumebox.close()})}if(e.lumebox.settings.platformMode=="mobile"){e("#lumebox-content, #lumebox-bg").quickGestures({dragRight:function(){e.lumebox.previous()},dragLeft:function(){e.lumebox.next()},mobile:true,drag:e("#lumebox-content"),threshold:50})}else{e("#lumebox-content").quickGestures({clickLeft:function(){e.lumebox.previous()},clickRight:function(){e.lumebox.next()}})}e(document).keydown(function(t){if(e.lumebox.data.popupStatus==1){switch(t.keyCode){case 27:e.lumebox.close();break;case 39:e.lumebox.next();break;case 78:e.lumebox.next();break;case 37:e.lumebox.previous();break;case 80:e.lumebox.previous();break}switch(t.charCode){case 110:e.lumebox.next();break;case 112:e.lumebox.previous();break}}});e(window).bind("resize",function(){e.lumebox.resize()});var i;e("a[rel^=lightbox]").each(function(){var r=this.rel.match(/\[([a-zA-Z0-9\-]*)\]/i);r=r?r[1]:null;if(r&&e.lumebox.data.lumeboxFeeds[r]){i=e.lumebox.data.lumeboxFeeds[r]}else if(r){i=new n;i.title=r;e.lumebox.data.lumeboxFeeds[r]=i}if(this.href.search(/(\.jpg|\.jpeg|\.gif|\.png)$/i)!=-1){var s,o=new t;if(e(this).attr("class")&&!e(this).attr("class").match(e.lumebox.settings.noCaptionClass))o.content=this.title;o.link=this.href;s=r?e.lumebox.data.lumeboxFeeds[r].items.push(o)-1:e.lumebox.data.lumeboxItems.items.push(o)-1;o.id=r+"-"+s;e(this).click(function(){e.lumebox.open({index:s,group:r});return false})}else if(e.lumebox.settings.feedApiKey!=false&&this.rel.search(/lightbox\[(rss[a-zA-Z0-9\-]*)\]/i)!=-1){var u=this;e.lumebox.parseFeed({url:e.lumebox.settings.proxy+this.href,success:function(t){e.each(t.items,function(t,n){o=e.extend({},o,n);r?e.lumebox.data.lumeboxFeeds[r].items.push(o)-1:e.lumebox.data.lumeboxItems.items.push(o)-1});e(u).click(function(){e.lumebox.open({index:null,group:r});return false})}})}});e.each(e.lumebox.settings.rss,function(t,n){e.lumebox.parseFeed({url:e.lumebox.settings.proxy+n,success:function(t){e.each(t.items,function(t,n){var r=e.extend({},r,n);e.lumebox.data.lumeboxItems.items.push(r)})}})});return this},resize:function(t){if(e.lumebox.data.popupStatus==1){var n=parseInt(e("#lumebox-popup").css("margin-top").replace("px",""));var r=e.lumebox.settings.platformMode=="mobile"?0:e("#lumebox-caption").outerHeight(true);var i=e(window).width()-2*n;var s=e(window).height()-2*n;var o=e("#lumebox-content").find("img.lumebox-img").attr("src")?e("#lumebox-content").find("img.lumebox-img").eq(0):false;var u=o?o.attr("width"):i;if(o){var a=o.attr("width")/o.attr("height");var f=0;var l=0;if(o[0].naturalWidth+2*n>i){f=i;l=i/a;u=i}else{f=o[0].naturalWidth;l=o[0].naturalWidth/a}if(l+r+2*n>=s){var c=s-r-2*n;l=c;f=c*a;u=l*a}else{u=f}o.attr("width",f);o.attr("height",l)}else{u=e.lumebox.settings.rssWidth}if(u<1)u=i;e("#lumebox-popup").css({width:u,left:(i-u)/2-(e.lumebox.settings.useParentOffset?e("body").offset().left:0)});var h=e("#lumebox-content").outerHeight(true)+e("#lumebox-footer").outerHeight(true);e("#lumebox-popup").css({height:h,top:e(window).scrollTop()+(h>s?0:s/2-h/2)});if(e.lumebox.settings.scrollToTop)e(this).scrollTop(0);if(e.isFunction(t))t()}},open:function(t){if(!t)t=new Object;e.lumebox.data.group=t.group?t.group:null;var n=t.group?e.lumebox.data.lumeboxFeeds[t.group]:e.lumebox.data.lumeboxItems;e.lumebox.data.index=t.index?t.index:0;var r;if(e.lumebox.settings.showAsList){r=n.items}else{var i=n.items[e.lumebox.data.index];r=[i]}if(e.lumebox.data.popupStatus==0){e("#lumebox-bg").css({opacity:e.lumebox.settings.opacity});if(e.lumebox.settings.platformMode=="mobile"){e("body > *").addClass("lumebox-hidden");e("html, body").addClass("lumebox")}e("#lumebox-bg").fadeIn("fast",function(){e("#lumebox-popup").css("opacity",0).show();e.lumebox.data.popupStatus=1;e.lumebox.switchPost(r,0,n)})}},close:function(){if(e.lumebox.data.popupStatus==1){if(e.lumebox.settings.platformMode=="mobile"){e("body > *").removeClass("lumebox-hidden");e("html, body").removeClass("lumebox")}e("#lumebox-bg").fadeOut(e.lumebox.settings.duration);e("#lumebox-popup").fadeOut(e.lumebox.settings.duration);e.lumebox.data.popupStatus=0}clearInterval(e.lumebox.data.timeoutId)},next:function(){var t=e.lumebox.data.group?e.lumebox.data.lumeboxFeeds[e.lumebox.data.group]:e.lumebox.data.lumeboxItems;e.lumebox.data.index=e.lumebox.data.index<t.items.length-1?e.lumebox.data.index+1:0;var n=t.items[e.lumebox.data.index];e.lumebox.switchPost([n],"next",t)},previous:function(){var t=e.lumebox.data.group?e.lumebox.data.lumeboxFeeds[e.lumebox.data.group]:e.lumebox.data.lumeboxItems;e.lumebox.data.index=e.lumebox.data.index>0?e.lumebox.data.index-1:t.items.length-1;var n=t.items[e.lumebox.data.index];e.lumebox.switchPost([n],"previous",t)},switchPost:function(t,n,r,i){if(e.lumebox.data.popupStatus==1){var s={opacity:0};var o=e.lumebox.settings.platformMode=="mobile"?e("#lumebox-content"):e("#lumebox-popup");o.animate(s,e.lumebox.settings.duration,function(){if(e.lumebox.settings.platformMode=="mobile"){e(this).css("-webkit-transform","translate3d(0,0,0)")}e("#lumebox-content").css("opacity",0).lboxFillContent(t,function(){e("#lumebox-popup").css("opacity",1);e("#lumebox-counter").html(e.lumebox.data.index+1+"/"+r.items.length);e.lumebox.resize(function(){e("#lumebox-popup").children(":not(.lumebox-controls)").animate({opacity:1},e.lumebox.settings.duration);if(e.isFunction(i))i()})})})}},parseFeed:function(r){if(r.url.search(/^http/i)!=-1){var i=new google.feeds.Feed(r.url);i.load(function(i){var s=new n;s.title=i.feed.title;s.link=i.feed.link;s.description=i.feed.description;s.version=i.feed.type;e(i.feed.entries).each(function(e,n){var r=new t;r.title=n.title;r.link=n.link;r.published=n.publishedDate;r.id=n.link;r.content=n.content;r.snippet=n.contentSnippet;s.items.push(r)});if(e.isFunction(r.success))r.success(s)})}},loadImage:function(t,n){if(e("#lboxItem-"+t.id).length<1){e("<img />").attr("src",t.link).load(n)}if(e("#lumebox-bg").find(".lumebox-preLoaded").length>50){e("#lumebox-bg").find(".lumebox-preLoaded").eq(0).remove()}var r=e.lumebox.data.group?e.lumebox.data.lumeboxFeeds[e.lumebox.data.group]:e.lumebox.data.lumeboxItems;var i=e.lumebox.data.index<r.items.length-1?e.lumebox.data.index+1:0;var s=e.lumebox.data.index<r.items.length-2?e.lumebox.data.index+2:0;var o=[r.items[i],r.items[s]];e.each(o,function(t,n){if(e("#lboxItem-"+n.id).length<1){e("<img />").attr("src",n.link).load(function(){e(this).attr({"class":"lumebox-preLoaded",id:"lboxItem-"+n.id,width:this.width,height:this.height}).appendTo("#lumebox-bg")})}})}};e.fn.lboxFillContent=function(n,r){return this.each(function(){var i=this;if(n.length==1&&n[0].link.search(/(\.jpg|\.jpeg|\.gif|\.png)$/i)!=-1){t=n[0];if(e("#lboxItem-"+t.id).length>0){e.lumebox.loadImage(t);e(i).html(e("#lboxItem-"+t.id).clone().attr("class","lumebox-img"));e(i).find("img.lumebox-img").wrap('<div class="post"><div class="post-body"></div></div>');if(t.content){e(i).find("div.post-body").append('<div id="lumebox-caption">'+t.content+"</div>")}if(e.isFunction(r))r()}else{e.lumebox.data.parentElement.append('<div id="lumebox-loading"><img src="'+e.lumebox.settings.graphicsDir+'ajax-loader.gif" /> Loading</div>');e.lumebox.loadImage(t,function(){e("#lumebox-loading").remove();e(this).attr({"class":"lumebox-img",width:this.width,height:this.height});e(i).html(this).find("img.lumebox-img").wrap('<div class="post"><div class="post-body"></div></div>');if(t.content){e(i).find("div.post-body").append('<div id="lumebox-caption">'+t.content+"</div>")}if(e.isFunction(r))r()})}}else{html="";e.each(n,function(e,t){var n="",r="";if(t.title)n='<div class="post-title"><h2><a href="'+t.link+'">'+t.title+"</a></h2></div>";r=t.content;html+='<div class="post hentry">'+n+'<div class="post-body>">'+r+"</div></div>"});e(i).html(html);if(e.isFunction(r))r()}})};e.fn.quickGestures=function(t){settings=e.extend({dragLeft:null,dragRight:null,clickLeft:null,clickRight:null,tap:null,hold:null,holdTime:1200,threshold:50,mobile:false,drag:true},t);this.each(function(){var t={x:0,y:0,t:null,time:null};if(!settings.mobile){e(this).mousedown(function(n){n.preventDefault();var r=(e(window).width()-e(this).outerWidth(true))/2;var i=(e(window).height()-e(this).outerHeight(true))/2;t.x=n.pageX-r;t.y=n.pageY-i;t.time=new Date;if(e.isFunction(settings.hold)){t.t=setTimeout("settings.hold()",settings.holdTime)}e(this).mouseup(function(){if(t.t!=null)clearTimeout(t.t);var i=n.pageX-r-t.x;var s=new Date;if(s.getTime()-t.time.getTime()<settings.holdTime&&i<settings.threshold){if(t.x<e(this).width()/2&&e.isFunction(settings.clickLeft)){settings.clickLeft()}else if(t.x>=e(this).width()/2&&e.isFunction(settings.clickRight)){settings.clickRight()}else if(e.isFunction(settings.tap)){settings.tap()}}e(this).unbind("mouseup")});e(this).mousemove(function(n){e(this).mouseup(function(){e(this).unbind("mousemove")});var i=n.pageX-r-t.x;if(i<=-settings.threshold){e(this).unbind("mousemove");if(e.isFunction(settings.dragLeft))settings.dragLeft()}else if(i>=settings.threshold){e(this).unbind("mousemove");if(e.isFunction(settings.dragRight))settings.dragRight()}})})}else{var n,r,i,s,o=0,u=0,a=e(this);a[0].addEventListener("touchstart",function(r){r.preventDefault();i=(e(window).width()-a.outerWidth(true))/2;s=(e(window).height()-a.outerHeight(true))/2;t.x=r.targetTouches[0].pageX-i;n=t.x;t.y=r.targetTouches[0].pageY-s;lastPagY=t.y;t.time=new Date;if(e.isFunction(settings.hold)){t.t=setTimeout("settings.hold()",settings.holdTime)}},false);a[0].addEventListener("touchmove",function(e){e.preventDefault();var a=e.touches[0].pageX||e.changedTouches[0].pageX;var f=e.touches[0].pageY||e.changedTouches[0].pageY;n=a-i;r=f-s;o=n-i-t.x;u=r-s-t.y;if(settings.drag){settings.drag.css("-webkit-transform","translate3d("+o+"px, 0, 0)")}},false);a[0].addEventListener("touchend",function(n){n.preventDefault();if(t.t!=null)clearTimeout(t.t);var r=new Date;if(o<=-settings.threshold){if(e.isFunction(settings.dragLeft)){settings.dragLeft()}}else if(o>=settings.threshold){if(e.isFunction(settings.dragRight)){settings.dragRight()}}else if(r.getTime()-t.time.getTime()<settings.holdTime){if(t.x<a.width()/2&&e.isFunction(settings.clickLeft)){settings.clickLeft()}else if(t.x>=a.width()/2&&e.isFunction(settings.clickRight)){settings.clickRight()}else if(e.isFunction(settings.tap)){settings.tap()}}else if(e.isFunction(settings.hold)){settings.hold()}else{settings.drag.css("-webkit-transform","translate3d(0, 0, 0)")}},false)}});return this};var r=typeof lumeboxOptions!="undefined"?lumeboxOptions:new Object;e.lumebox.loader(r)})(jQuery)